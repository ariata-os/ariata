name: mac_messages
source: mac
display_name: Messages
description: iMessage and SMS conversation history
ingestion:
  type: push
  batch_type: events
  raw_data_type: MessageEvent
processor:
  table_name: stream_mac_messages
processing:
  deduplication:
    strategy: unique_key
    key: 
    - message_id
  normalization: true
  validation:
    required_fields:
    - message_id
    - chat_id
    - date
    - text
storage:
  retention_days: 365
  compression: gzip
  format: json
schema:
  table_name: stream_mac_messages
  description: iMessage and SMS messages from macOS
  columns:
  - name: message_id
    type: string
    max_length: 200
    nullable: false
    description: Unique message identifier (GUID)
  - name: chat_id
    type: string
    max_length: 200
    nullable: false
    description: Chat/conversation identifier
  - name: handle_id
    type: string
    max_length: 200
    nullable: true
    description: Contact handle (phone/email)
  - name: text
    type: text
    nullable: true
    description: Message content
  - name: service
    type: string
    max_length: 50
    nullable: true
    description: Service type (iMessage, SMS)
  - name: is_from_me
    type: boolean
    nullable: false
    default: false
    description: Whether message was sent by user
  - name: date
    type: timestamp
    nullable: false
    description: Message timestamp
  - name: date_read
    type: timestamp
    nullable: true
    description: When message was read
  - name: date_delivered
    type: timestamp
    nullable: true
    description: When message was delivered
  - name: is_read
    type: boolean
    nullable: true
    default: false
    description: Whether message has been read
  - name: is_delivered
    type: boolean
    nullable: true
    default: false
    description: Whether message was delivered
  - name: is_sent
    type: boolean
    nullable: true
    default: false
    description: Whether message was sent successfully
  - name: cache_has_attachments
    type: boolean
    nullable: true
    default: false
    description: Whether message has attachments
  - name: attachment_count
    type: integer
    nullable: true
    description: Number of attachments
  - name: attachment_info
    type: jsonb
    nullable: true
    description: Attachment metadata (filenames, types, sizes)
  - name: group_title
    type: string
    max_length: 500
    nullable: true
    description: Group chat name if applicable
  - name: associated_message_guid
    type: string
    max_length: 200
    nullable: true
    description: Related message ID (for replies/reactions)
  - name: associated_message_type
    type: integer
    nullable: true
    description: Type of association (reply, reaction, etc)
  - name: expressive_send_style_id
    type: string
    max_length: 100
    nullable: true
    description: Message effect style (invisible ink, etc)
  - name: raw_data
    type: jsonb
    nullable: true
    description: Additional unmapped fields
  indexes:
  - columns:
    - timestamp
    type: btree
    description: Primary time-series index
  - columns:
    - message_id
    type: btree
    unique: true
    description: Unique message ID index
  - columns:
    - chat_id
    - date
    type: btree
    description: Index for chat-specific queries
  - columns:
    - is_from_me
    - date
    type: btree
    description: Index for sent/received filtering
  - columns:
    - source_id
    - message_id
    type: btree
    unique: true
    description: Composite unique constraint for deduplication
  storage:
    strategy: hybrid
    minio_fields:
    - attachment_info
    - raw_data
    note: Message text stays in PostgreSQL, attachments metadata in MinIO